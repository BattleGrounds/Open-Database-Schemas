name: Generate Prisma Schema from SQL

on:
  push:
    paths:
      - 'LearningManagementSystems/**/*.sql'
      - '!**/*.prisma' # –ù–µ –∑–∞–ø—É—Å–∫–∞—Ç—å, –µ—Å–ª–∏ –º–µ–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ .prisma
    branches:
      - main
      - master

jobs:
  generate-prisma:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.head_ref || github.ref }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Prisma CLI
        run: npm install -g prisma

      - name: Find SQL files
        id: find_sql
        run: |
          SQL_FILES=$(find LearningManagementSystems -name "*.sql" -type f)
          if [ -z "$SQL_FILES" ]; then
            echo "No SQL files found"
            exit 1
          fi
          echo "files=$SQL_FILES" >> $GITHUB_OUTPUT

      - name: Process each SQL file
        run: |
          while IFS= read -r sql_file; do
            echo "Processing $sql_file"

            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É—Ç—å –∫ Prisma-—Ñ–∞–π–ª—É
            prisma_file="${sql_file%.sql}.prisma"
            temp_db="/tmp/$(basename ${sql_file%.sql}).db"

            # –°–æ–∑–¥–∞—ë–º –≤—Ä–µ–º–µ–Ω–Ω—É—é SQLite –±–∞–∑—É
            sqlite3 "$temp_db" < "$sql_file"

            # –ï—Å–ª–∏ Prisma-—Ñ–∞–π–ª –µ—â—ë –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç ‚Äî —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π schema.prisma
            if [ ! -f "$prisma_file" ]; then
              mkdir -p "$(dirname "$prisma_file")"
              cat > "$prisma_file" << EOF
// Auto-generated from $sql_file
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = "file:$temp_db"
}

// Models will be added below
EOF
            fi

            # –ò–Ω—Ç—Ä–æ—Å–ø–µ–∫—Ü–∏—è: –ø–æ–ª—É—á–∞–µ–º —Å—Ö–µ–º—É –∏–∑ SQL —á–µ—Ä–µ–∑ SQLite
            npx prisma db pull --schema="$prisma_file" --force

            # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º
            npx prisma format --schema="$prisma_file"

            echo "‚úÖ Generated Prisma schema: $prisma_file"
          done <<< "$(find LearningManagementSystems -name "*.sql" -type f)"

      - name: Commit and Push Prisma files
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ .prisma —Ñ–∞–π–ª—ã
          git add **/*.prisma

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è
          if git diff-index --quiet HEAD --; then
            echo "‚úÖ No changes to commit"
            exit 0
          else
            git commit -m "ü§ñ Auto-generate Prisma schema from SQL
            Generated via GitHub Actions when SQL was updated."
            git push origin HEAD:main
            echo "‚úÖ Prisma schemas committed and pushed"
          fi
